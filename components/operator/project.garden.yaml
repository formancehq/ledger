---
kind: Project
name: operator

variables:
  cluster-name: formance

environments:
  - name: default
    providers:
    - name: kubernetes
      setupIngressController: false

providers:
  - name: kubernetes
    context: k3d-formance
    buildMode: kaniko
    kaniko:
      extraFlags: # TODO: Make optional registries flag
      - --registry-mirror=registry-docker-io:5000
      - --insecure-registry=registry-docker-io:5000
      - --force
      - --snapshotMode=redo
      - --use-new-run
    deploymentRegistry:
      hostname: internal-registry
      namespace: formancehq
      insecure: true
      port: 5000
---
kind: Module
name: operator-build-image
description: Operator build
type: container
include:
- pkg
- internal
- controllers
- apis
- vendor
- main.go
- go.*
- Dockerfile
build:
  targetImage: "${command.params contains 'dev' && command.params.dev contains 'operator' ? 'reloader': 'release' }"
---
kind: Module
description: Update operator version
type: exec
name: operator-build-manifest
include:
- config
build:
  command:
  - >
    cd config/manager &&
    kustomize edit set image controller=internal-registry:5000/formancehq/operator-build-image:${modules.operator-build-image.version}
disabled: true
---
kind: Module
name: operator
description: Operator manifests
type: kubernetes
include:
- config
- main.go
- vendor
- pkg
- controllers
- apis
- go.*
kustomize:
  path: config/default
dependencies:
- cert-manager
build:
  dependencies:
  - name: operator-build-image
  - name: operator-build-manifest
    copy:
    - source: config
      target: config
serviceResource:
  kind: Deployment
  name: formance-operator-controller-manager
  containerName: manager
  containerModule: operator-build-image
devMode:
  command:
  - air
  - --
  containerName: manager
  sync:
  - target: /workspace
