name: Generate dataset
on:
  workflow_dispatch:
    inputs:
      ledger-version:
        description: 'The version of the ledger to deploy'
        required: true
      preview:
        description: 'Preview the changes'
        required: false
        type: boolean
      rds-db-subnet-group-name:
        description: 'The network to deploy the RDS instance to'
        required: false
      until-log-id:
        description: 'The log id to stop at'
        required: false
      generator-version:
        default: 'latest'
        description: 'The version of the generator to use'
        required: false
      namespace:
        default: 'default'
        description: 'The namespace to deploy the dataset to'
        required: false
      create-snapshot:
        default: 'false'
        description: 'Create a snapshot of the dataset'
        required: false
      script:
        required: true
        description: 'The script to generate the dataset'
      organization:
        description: 'The organization to deploy the dataset to'
        required: false
        default: formance
      kubeconfig:
        description: 'The kubeconfig to use'
        required: true

concurrency:
  group: dataset-${{ github.event.inputs.ledger-version }}
  cancel-in-progress: true

jobs:
  Run:
    name: Generate dataset
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        name: Checkout
      - uses: actions/setup-go@v5
        with:
          go-version: '^1.23'
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::288350113309:role/github-access
          aws-region: eu-west-1
          #aws-region: us-east-1
      - name: Create kube config file
        env:
          KUBE_APISERVER: ${{ secrets.FORMANCE_DEV_KUBE_API_SERVER_ADDRESS }}
          KUBE_TOKEN: ${{ secrets.FORMANCE_DEV_KUBE_TOKEN }}
        run: |
          mkdir .kube;
          
          cat <<EOF > .kube/config
          apiVersion: v1
          kind: Config
          clusters:
            - cluster:
                insecure-skip-tls-verify: true
                server: $KUBE_APISERVER
              name: default
          contexts:
            - name: default
              context:
                cluster: default
                user: default
          users:
            - name: default
              user:
                token: $KUBE_TOKEN
          current-context: default
          EOF
      - uses: pulumi/actions@v6
        name: Run Pulumi
        with:
          command: ${{ github.event.inputs.preview == 'true' && 'preview' || 'up' }}
          stack-name: ${{ github.event.inputs.organization }}/ledger-dataset/${{ github.event.inputs.ledger-version }}
          work-dir: './tools/dataset'
          config-map: |
            ledger-version:
              value: ${{ github.event.inputs.ledger-version }}
            rds-db-subnet-group-name:
              value: ${{ github.event.inputs.rds-db-subnet-group-name }}
            until-log-id:
              value: ${{ github.event.inputs.until-log-id }}
            generator-version:
              value: ${{ github.event.inputs.generator-version }}
            namespace:
              value: ${{ github.event.inputs.namespace }}
            create-snapshot:
              value: ${{ github.event.inputs.create-snapshot }}
            script:
              value: "${{ github.event.inputs.script }}"
          upsert: 'true'
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - uses: pulumi/actions@v6
        name: Clean resources
        with:
          command: destroy
          stack-name: ${{ github.event.inputs.organization }}/ledger-dataset/${{ github.event.inputs.ledger-version }}
          work-dir: './tools/dataset'