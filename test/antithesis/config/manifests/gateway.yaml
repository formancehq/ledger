apiVersion: v1
kind: Service
metadata:
  name: gateway
  namespace: formance-dev
spec:
  selector:
    app: gateway
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-config
  namespace: formance-dev
data:
  Caddyfile: |
    {
      # Local env dev config
      auto_https off
      debug
    }

    :8080 {
        reverse_proxy {
            to ledger1:8080 ledger2:8080
            lb_policy first
        }
    }
---
apiVersion: v1
kind: Pod
metadata:
  name: gateway
  namespace: formance-dev
  labels:
    app: gateway

spec:
  volumes:
    - name: caddyfile
      configMap:
        name: gateway-config

  containers:
    - name: gateway
      image: ghcr.io/formancehq/gateway:v2.0.0-rc.20
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /etc/caddy/Caddyfile
          name: caddyfile
          subPath: Caddyfile
      ports:
        - containerPort: 8080
          hostPort: 8080
