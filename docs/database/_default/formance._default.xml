<?xml version="1.0" encoding="UTF-8"?><database name="formance" schema="_default" type="PostgreSQL - 15.8">
   <sequences>
      <sequence increment="1" name="accounts_metadata_seq_seq" startValue="1"/>
      <sequence increment="1" name="accounts_seq_seq" startValue="1"/>
      <sequence increment="1" name="goose_db_version_id_seq" startValue="1"/>
      <sequence increment="1" name="logs_seq_seq" startValue="1"/>
      <sequence increment="1" name="moves_seq_seq" startValue="1"/>
      <sequence increment="1" name="transactions_metadata_seq_seq" startValue="1"/>
   </sequences>
   <tables>
      <table name="accounts" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.accounts_seq_seq'::regclass)" digits="0" id="0" name="seq" nullable="false" remarks="" size="19" type="bigserial" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="address" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="address_array" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="4" name="insertion_date" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="5" name="updated_at" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="'{}'::jsonb" digits="0" id="6" name="metadata" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="7" name="first_usage" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <primaryKey column="seq" sequenceNumberInPK="1"/>
         <index name="accounts_pkey" unique="true">
            <column ascending="true" name="seq"/>
         </index>
         <index name="accounts_first_usage" unique="false">
            <column ascending="true" name="first_usage"/>
         </index>
         <index name="accounts_ledger" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="address"/>
            <column ascending="true" name="seq"/>
         </index>
      </table>
      <table name="accounts_metadata" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.accounts_metadata_seq_seq'::regclass)" digits="0" id="0" name="seq" nullable="false" remarks="" size="19" type="bigserial" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="'{}'::jsonb" digits="0" id="2" name="metadata" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="3" name="revision" nullable="true" remarks="" size="0" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="4" name="date" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="accounts_address" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <primaryKey column="seq" sequenceNumberInPK="1"/>
         <index name="accounts_metadata_pkey" unique="true">
            <column ascending="true" name="seq"/>
         </index>
         <index name="accounts_metadata_ledger" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="accounts_address"/>
            <column ascending="true" name="revision"/>
         </index>
         <index name="accounts_metadata_metadata" unique="false">
            <column ascending="true" name="metadata"/>
         </index>
         <index name="accounts_metadata_revisions" unique="false">
            <column ascending="true" name="accounts_address"/>
            <column ascending="false" name="revision"/>
            <column ascending="true" name="metadata"/>
            <column ascending="true" name="date"/>
         </index>
      </table>
      <table name="accounts_volumes" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="accounts_address" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="asset" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="input" nullable="false" remarks="" size="0" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="output" nullable="false" remarks="" size="0" type="numeric" typeCode="2"/>
         <primaryKey column="ledger" sequenceNumberInPK="1"/>
         <primaryKey column="accounts_address" sequenceNumberInPK="2"/>
         <primaryKey column="asset" sequenceNumberInPK="3"/>
         <index name="accounts_volumes_pkey" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="accounts_address"/>
            <column ascending="true" name="asset"/>
         </index>
      </table>
      <table name="goose_db_version" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.goose_db_version_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="version_id" nullable="false" remarks="" size="19" type="int8" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="is_applied" nullable="false" remarks="" size="1" type="bool" typeCode="-7"/>
         <column autoUpdated="false" defaultValue="now()" digits="6" id="3" name="tstamp" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="goose_db_version_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="logs" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.logs_seq_seq'::regclass)" digits="0" id="0" name="seq" nullable="false" remarks="" size="19" type="bigserial" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="id" nullable="false" remarks="" size="0" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="type" nullable="false" remarks="" size="2147483647" type="&quot;_default&quot;.&quot;log_type&quot;" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="hash" nullable="true" remarks="" size="2147483647" type="bytea" typeCode="-2"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="5" name="date" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="data" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="idempotency_key" nullable="true" remarks="" size="255" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="idempotency_hash" nullable="true" remarks="" size="2147483647" type="bytea" typeCode="-2"/>
         <primaryKey column="seq" sequenceNumberInPK="1"/>
         <index name="logs_pkey" unique="true">
            <column ascending="true" name="seq"/>
         </index>
         <index name="logs_idempotency_key" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="idempotency_key"/>
         </index>
         <index name="logs_ledger" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="moves" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.moves_seq_seq'::regclass)" digits="0" id="0" name="seq" nullable="false" remarks="" size="19" type="bigserial" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="accounts_address" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="asset" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="amount" nullable="false" remarks="" size="0" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="5" name="insertion_date" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="6" name="effective_date" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="is_source" nullable="false" remarks="" size="1" type="bool" typeCode="-7"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="transactions_id" nullable="false" remarks="" size="19" type="int8" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="post_commit_volumes" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="10" name="post_commit_effective_volumes" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <primaryKey column="seq" sequenceNumberInPK="1"/>
         <index name="moves_pkey" unique="true">
            <column ascending="true" name="seq"/>
         </index>
         <index name="moves_account_address" unique="false">
            <column ascending="true" name="accounts_address"/>
         </index>
         <index name="moves_asset" unique="false">
            <column ascending="true" name="asset"/>
         </index>
         <index name="moves_date" unique="false">
            <column ascending="true" name="effective_date"/>
         </index>
         <index name="moves_ledger" unique="false">
            <column ascending="true" name="ledger"/>
         </index>
         <index name="moves_range_dates" unique="false">
            <column ascending="true" name="accounts_address"/>
            <column ascending="true" name="asset"/>
            <column ascending="true" name="effective_date"/>
         </index>
      </table>
      <table name="transactions" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="id" nullable="false" remarks="" size="19" type="int8" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="2" name="timestamp" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="reference" nullable="true" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="4" name="reverted_at" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="5" name="updated_at" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="postings" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="sources" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="destinations" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="sources_arrays" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="10" name="destinations_arrays" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="'{}'::jsonb" digits="0" id="11" name="metadata" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="(now() AT TIME ZONE 'utc'::text)" digits="6" id="12" name="inserted_at" nullable="true" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="13" name="post_commit_volumes" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <index name="transactions_date" unique="false">
            <column ascending="true" name="timestamp"/>
         </index>
         <index name="transactions_ledger" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="id"/>
         </index>
         <index name="transactions_metadata_index" unique="false">
            <column ascending="true" name="metadata"/>
         </index>
         <index name="transactions_reference" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="reference"/>
         </index>
      </table>
      <table name="transactions_metadata" remarks="" schema="_default" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('_default.transactions_metadata_seq_seq'::regclass)" digits="0" id="0" name="seq" nullable="false" remarks="" size="19" type="bigserial" typeCode="-5"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="ledger" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="2" name="revision" nullable="false" remarks="" size="0" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="3" name="date" nullable="false" remarks="" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="'{}'::jsonb" digits="0" id="4" name="metadata" nullable="false" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="transactions_id" nullable="false" remarks="" size="19" type="int8" typeCode="-5"/>
         <primaryKey column="seq" sequenceNumberInPK="1"/>
         <index name="transactions_metadata_pkey" unique="true">
            <column ascending="true" name="seq"/>
         </index>
         <index name="transactions_metadata_ledger" unique="true">
            <column ascending="true" name="ledger"/>
            <column ascending="true" name="transactions_id"/>
            <column ascending="true" name="revision"/>
         </index>
         <index name="transactions_metadata_metadata" unique="false">
            <column ascending="true" name="metadata"/>
         </index>
         <index name="transactions_metadata_revisions" unique="false">
            <column ascending="true" name="transactions_id"/>
            <column ascending="false" name="revision"/>
            <column ascending="true" name="metadata"/>
            <column ascending="true" name="date"/>
         </index>
      </table>
   </tables>
   <routines>
      <routine dataAccess="MODIFIES" deterministic="true" name="explode_address(_address character varying)" returnType="jsonb" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="sql"><![CDATA[select public.aggregate_objects(jsonb_build_object(data.number - 1, data.value))
from (select row_number() over () as number, v.value
      from (select unnest(string_to_array(_address, ':')) as value
            union all
            select null) v) data]]></definition>
         <parameters>
            <parameter mode="IN" name="_address" type="character varying"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="insert_account_metadata_history()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	insert into "_default".accounts_metadata (ledger, accounts_address, revision, date, metadata)
	values (new.ledger, new.address, 1, new.insertion_date, new.metadata);

	return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="insert_transaction_metadata_history()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	insert into "_default".transactions_metadata (ledger, transactions_id, revision, date, metadata)
	values (new.ledger, new.id, 1, new.timestamp, new.metadata);

	return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_address_array_for_account()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	new.address_array = to_json(string_to_array(new.address, ':'));

	return new;
end]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_effective_volumes()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
    new.post_commit_effective_volumes = coalesce((
        select json_build_object(
            'input', (post_commit_effective_volumes->>'input')::numeric + case when new.is_source then 0 else new.amount end,
            'output', (post_commit_effective_volumes->>'output')::numeric + case when new.is_source then new.amount else 0 end
        )
        from "_default".moves
        where accounts_address = new.accounts_address
            and asset = new.asset
            and ledger = new.ledger
            and (effective_date < new.effective_date or (effective_date = new.effective_date and seq < new.seq))
        order by effective_date desc, seq desc
        limit 1
    ), json_build_object(
        'input', case when new.is_source then 0 else new.amount end,
        'output', case when new.is_source then new.amount else 0 end
    ));

    return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_transaction_addresses()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin

	new.sources = (
		select to_jsonb(array_agg(v->>'source')) as value
		from jsonb_array_elements(new.postings::jsonb) v
	);
	new.destinations = (
		select to_jsonb(array_agg(v->>'destination')) as value
		from jsonb_array_elements(new.postings::jsonb) v
	);

	return new;
end]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_transaction_addresses_segments()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	new.sources_arrays = (
		select to_jsonb(array_agg("_default".explode_address(v ->> 'source'))) as value
		from jsonb_array_elements(new.postings::jsonb) v
	);
	new.destinations_arrays = (
		select to_jsonb(array_agg("_default".explode_address(v ->> 'destination'))) as value
		from jsonb_array_elements(new.postings::jsonb) v
	);

	return new;
end]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="update_account_metadata_history()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	insert into "_default".accounts_metadata (ledger, accounts_address, revision, date, metadata)
	values (new.ledger, new.address, (
		select revision + 1
		from "_default".accounts_metadata
		where accounts_metadata.accounts_address = new.address
		order by revision desc
		limit 1
	), new.updated_at, new.metadata);

	return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="update_effective_volumes()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
    update "_default".moves
    set post_commit_effective_volumes = json_build_object(
		'input', (post_commit_effective_volumes->>'input')::numeric + case when new.is_source then 0 else new.amount end,
		'output', (post_commit_effective_volumes->>'output')::numeric + case when new.is_source then new.amount else 0 end
    )
    where accounts_address = new.accounts_address
        and asset = new.asset
        and effective_date > new.effective_date
        and ledger = new.ledger;

    return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="update_transaction_metadata_history()" returnType="trigger" securityType="DEFINER" type="FUNCTION">
         <comment/>
         <definition language="plpgsql"><![CDATA[begin
	insert into "_default".transactions_metadata (ledger, transactions_id, revision, date, metadata)
	values (new.ledger, new.id, (
		select revision + 1
		from "_default".transactions_metadata
		where transactions_metadata.transactions_id = new.id and transactions_metadata.ledger = new.ledger
		order by revision desc
		limit 1
	), new.updated_at, new.metadata);

	return new;
end;]]></definition>
         <parameters>
            <parameter mode="IN"/>
         </parameters>
      </routine>
   </routines>
</database>
